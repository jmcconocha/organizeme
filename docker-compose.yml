services:
  api:
    build:
      context: ./web/api
      dockerfile: Dockerfile
    image: ppm-api:latest
    container_name: ppm_api
    environment:
      APP_ENV: ${APP_ENV:-development}
      DATABASE_URL: sqlite:////app/data/ppm.db
      SESSION_SECRET: ${SESSION_SECRET:-dev-secret-change-in-prod}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
      SCAN_INTERVAL_MINUTES: ${SCAN_INTERVAL_MINUTES:-60}
      RATE_LIMIT_PER_MINUTE: ${RATE_LIMIT_PER_MINUTE:-120}
      PYTHONUNBUFFERED: "1"
    volumes:
      - ./data:/app/data
      - ./web/api/app:/app/app
      - ./web/api/alembic:/app/alembic
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/healthz"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    restart: unless-stopped

  worker:
    build:
      context: ./web/api
      dockerfile: Dockerfile
    image: ppm-worker:latest
    container_name: ppm_worker
    environment:
      APP_ENV: ${APP_ENV:-development}
      DATABASE_URL: sqlite:////app/data/ppm.db
      SESSION_SECRET: ${SESSION_SECRET:-dev-secret-change-in-prod}
      RATE_LIMIT_PER_MINUTE: ${RATE_LIMIT_PER_MINUTE:-120}
      PYTHONUNBUFFERED: "1"
    volumes:
      - ./data:/app/data
      - ./web/api/app:/app/app
      - ./web/api/worker:/app/worker
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 5s
      retries: 3
    command: ["python", "-m", "worker.scanner"]
    restart: unless-stopped

  frontend:
    build:
      context: ./web/ui
      dockerfile: Dockerfile
    image: ppm-frontend:latest
    container_name: ppm_frontend
    environment:
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:8000}
    ports:
      - "5173:5173"
    volumes:
      - ./web/ui:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:5173"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

volumes:
  ppm_data:
    name: ppm_data
